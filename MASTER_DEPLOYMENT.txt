# Suterra Visitor System - Complete Update Package
## December 2, 2025

---

## üéØ Three Major Features Implemented

### 1. ‚úÖ Smartsheet Pre-Fill for Expired Contractors
**What it does:** Skip orientation video, open pre-filled Smartsheet form

### 2. ‚úÖ "Who Are You Visiting?" Field
**What it does:** Searchable dropdown with all Suterra contacts

### 3. ‚úÖ Automatic 2-Year Record Purge
**What it does:** Automatically delete visitor records with no check-ins for 2+ years

---

## üì¶ Complete File List

### Main Visitor Check-In System:
- ‚úÖ `index.php` - Main check-in page (Features 1 & 2)
- ‚úÖ `api/checkin.php` - Check-in API (Feature 2)
- ‚úÖ `api/database.php` - Database functions (Features 2 & 3)
- ‚úÖ `api/search-visitors.php` - Visitor search (Feature 2)

### Admin Dashboard:
- ‚úÖ `admin/index.php` - Admin dashboard (Feature 3)
- ‚úÖ `api/purge-old-visitors.php` - Purge API (Feature 3)

### Database & Setup:
- ‚úÖ `add-suterra-contact-column.php` - Migration for Feature 2
- ‚úÖ `auto-purge.php` - Standalone purge script (Feature 3)
- ‚úÖ `run-auto-purge.bat` - Windows Task Scheduler batch (Feature 3)

### Documentation:
- ‚úÖ `DEPLOYMENT_GUIDE.txt` - Features 1 & 2 deployment
- ‚úÖ `AUTO_PURGE_GUIDE.txt` - Feature 3 deployment
- ‚úÖ `MASTER_DEPLOYMENT.txt` - This file

---

## üöÄ Quick Start Deployment

### Step 1: Backup Everything
```
1. Admin Dashboard ‚Üí "Backup Database" button
2. Save backup file safely
3. Copy current PHP files as backup
```

### Step 2: Deploy Files (Order Matters!)

**First - Database Migration:**
```
1. Upload: add-suterra-contact-column.php (to web root)
2. Visit: http://yourserver/add-suterra-contact-column.php
3. Should see: "‚úÖ Successfully added 'suterra_contact' column"
4. Delete the migration file
```

**Second - Replace Main Files:**
```
1. Upload & replace: index.php (web root)
2. Upload & replace: api/checkin.php
3. Upload & replace: api/database.php
4. Upload & replace: api/search-visitors.php
```

**Third - Add Purge System:**
```
1. Upload & replace: admin/index.php
2. Upload new: api/purge-old-visitors.php
3. Upload new: auto-purge.php (web root)
4. Upload new: run-auto-purge.bat (web root)
```

### Step 3: Test Each Feature

**Test Feature 1: Smartsheet Pre-Fill**
```
1. Create test contractor with expired training (admin panel)
2. Try to check them in
3. Should skip video and open pre-filled Smartsheet form
4. Verify Name, Company, Email are pre-filled
```

**Test Feature 2: Visiting Field**
```
1. Check in a new visitor
2. See "Who are you visiting?" dropdown
3. Type to search (e.g., "Lea")
4. Select contact and complete check-in
5. Verify it shows in admin dashboard
```

**Test Feature 3: Auto-Purge**
```
1. Load admin dashboard
2. Check "Auto-Purge: Old Records Management" section
3. Click "üóëÔ∏è Purge Old Records" button
4. Review preview (may be empty if no old records)
5. Cancel or confirm
```

---

## üìã Feature Details

### Feature 1: Smartsheet Integration

**User Flow:**
```
Contractor with expired training checks in
    ‚Üì
System detects expired training
    ‚Üì
‚ùå SKIPS orientation video
    ‚Üì
‚úÖ Opens Smartsheet form
    ‚Üì
Pre-fills: Name, Company, Email
    ‚Üì
User: Selects Suterra Contact + Answers questions
    ‚Üì
‚úÖ Automatically checked in
    ‚Üì
‚úÖ Training certification renewed
```

**Smartsheet Form URL:**
`https://app.smartsheet.com/b/form/dbe783baf6fb47a6b886b96d54e4c770`

**Pre-fill Format:**
`?Name=John+Smith&Company=Acme&Email=john@acme.com`

---

### Feature 2: Suterra Contact Field

**Contact List (15 people):**
1. Aman Khapoya
2. Cheyne Detwiler
3. Chris Henry
4. Cody Moore
5. Graydon Olson
6. Jackie Graybeal
7. Jason Schweitzer
8. Jeff Sentman
9. John Crosby
10. Lea Hart
11. Logan Barber
12. Olivia Crisp
13. Sara Kuessner
14. Stan Reeder
15. Trevorr Beaver

**Features:**
- Searchable dropdown (type to filter)
- Optional field (can be left blank)
- Auto-fills for returning visitors
- Stored in database for reports
- Exports in CSV reports

**Database Column:**
- Name: `suterra_contact`
- Type: TEXT
- Nullable: Yes

---

### Feature 3: Auto-Purge System

**Three-Layer System:**

**Layer 1: Dashboard Auto-Check**
- Runs when admin loads dashboard
- Once per day maximum
- Silent operation
- No user action needed

**Layer 2: Windows Task Scheduler**
- Scheduled daily at 2 AM
- Independent of dashboard access
- Logs to file
- Requires setup (see AUTO_PURGE_GUIDE.txt)

**Layer 3: Manual Button**
- In admin dashboard
- Shows preview before deletion
- Immediate execution
- Good for testing

**What Gets Purged:**
- Visitor records with NO check-ins for 2+ years
- Their complete visit history
- Example: Last check-in Jan 1, 2023 ‚Üí PURGED in 2025

**What's Protected:**
- Anyone with check-in within last 2 years
- All training certifications
- Recent visitor data

**Dashboard Location:**
Section: "Auto-Purge: Old Records Management"
Shows:
- Last Auto-Purge date
- Records eligible for purge
- Manual purge button

---

## üéõÔ∏è Configuration Options

### Smartsheet Form URL
**Location:** `index.php`, line ~842
```javascript
const baseUrl = 'https://app.smartsheet.com/b/form/dbe783baf6fb47a6b886b96d54e4c770';
```

### Suterra Contacts List
**Location:** `index.php`, lines ~345-360
```html
<datalist id="suterra-contacts">
    <option value="Aman Khapoya">
    <option value="Cheyne Detwiler">
    <!-- Add/remove contacts here -->
</datalist>
```

### Auto-Purge Threshold
**Location:** `api/database.php`, line ~252
```php
// Default: 2 years
$two_years_ago = date('Y-m-d H:i:s', strtotime('-2 years'));

// Change to 3 years:
$two_years_ago = date('Y-m-d H:i:s', strtotime('-3 years'));
```

---

## üîç Testing Checklist

### Before Going Live:

**General Tests:**
- [ ] Database backup created
- [ ] All files uploaded correctly
- [ ] Migration script ran successfully
- [ ] Admin dashboard loads without errors
- [ ] Main check-in page loads without errors

**Feature 1 Tests:**
- [ ] Expired contractor skips video
- [ ] Smartsheet form opens
- [ ] Name, Company, Email are pre-filled
- [ ] Can select Suterra contact
- [ ] Auto check-in after form opens
- [ ] Training certification renewed

**Feature 2 Tests:**
- [ ] "Who are you visiting?" field appears
- [ ] Dropdown shows all 15 contacts
- [ ] Type-to-search works (type "Lea" shows "Lea Hart")
- [ ] Field is optional (can leave blank)
- [ ] Returning visitor auto-fills contact
- [ ] Shows in admin dashboard
- [ ] Exports in CSV

**Feature 3 Tests:**
- [ ] Auto-purge section appears in admin
- [ ] Shows last purge date
- [ ] Shows record count
- [ ] Manual purge button works
- [ ] Preview shows correct records
- [ ] Deletion works correctly
- [ ] Logs to file (if Task Scheduler set up)

---

## ‚ö†Ô∏è Common Issues & Solutions

### Issue: "Column suterra_contact not found"
**Solution:** Run the migration script `add-suterra-contact-column.php`

### Issue: Smartsheet form not pre-filling
**Check:**
- Form URL is correct
- Parameters format: `?Name=X&Company=Y&Email=Z`
- URL encoding is correct (spaces = `+` or `%20`)

### Issue: Suterra contact dropdown empty
**Check:**
- Browser supports HTML5 `<datalist>` (all modern browsers do)
- JavaScript not blocked
- Console (F12) for errors

### Issue: Auto-purge not running
**Check:**
- Admin dashboard loaded today
- Check logs: `data/visitor_system.log`
- Task Scheduler configured (if using)
- File permissions on `data` folder

### Issue: Manual purge shows "No records"
**This is normal!** Means all visitors checked in within 2 years.

---

## üìä Expected Performance

### Database Size Impact:
**Before auto-purge:**
- 5,000 visitors
- 50,000 visits
- Database: ~50 MB

**After 2 years (without purge):**
- 8,000 visitors (+3,000 never returned)
- 80,000 visits
- Database: ~80 MB

**After 2 years (with auto-purge):**
- 5,000 visitors (3,000 purged)
- 65,000 visits (old visits removed)
- Database: ~60 MB

**Benefit:** ~25% smaller database, faster queries

### Check-In Speed:
- No noticeable impact
- Smartsheet popup adds <1 second
- Auto-fill saves user time overall

### Admin Dashboard:
- Auto-purge check adds <1 second to load
- Only checks once per day
- Manual purge preview: ~2-3 seconds

---

## üîê Security Notes

### Authentication:
- All purge operations require admin login
- API endpoints check session authentication
- Standalone script only runs from localhost/CLI

### Data Protection:
- Backups recommended before major purges
- Preview before deletion (manual purge)
- Logs all purge operations

### Access Control:
- Auto-purge script: localhost or CLI only
- Admin dashboard: password protected
- API endpoints: session-based auth

---

## üìù Maintenance Schedule

### Daily (Automatic):
- Auto-purge checks for old records
- Runs silently if needed
- Logs results

### Weekly (Admin):
- Review "Records to Purge" count
- Check for any anomalies
- Verify auto-purge running

### Monthly (Admin):
- Review purge logs
- Backup database
- Verify all features working

### Quarterly (Admin):
- Review contact list (add/remove people)
- Check Smartsheet form still works
- Adjust purge threshold if needed

---

## üéì Training for Staff

### For Front Desk / Kiosk Users:
**New Field:**
"When checking in visitors, ask: 'Who are you here to see?' and select from dropdown."

**No other changes** - system works the same otherwise.

### For Contractors:
**Expired Training:**
"If your training has expired, you'll be directed to complete a short form and test instead of watching the full video again."

### For Admins:
**New Button:**
"üóëÔ∏è Purge Old Records" - removes visitors who haven't been here in 2+ years.

**New Section:**
"Auto-Purge: Old Records Management" - shows when last purge ran and how many records are eligible.

**No action needed** - system maintains itself automatically.

---

## üìû Support

### Self-Service:
1. Check this guide first
2. Review AUTO_PURGE_GUIDE.txt for purge details
3. Check logs: `data/visitor_system.log`
4. Review console (F12) for JavaScript errors

### Escalation:
- Provide error messages
- Screenshot of issue
- Copy of relevant log entries
- Steps to reproduce

---

## ‚úÖ Success Criteria

### Feature 1 Success:
- [ ] Contractors with expired training skip video
- [ ] Smartsheet form opens with data pre-filled
- [ ] Training automatically renewed after form

### Feature 2 Success:
- [ ] All 15 contacts appear in dropdown
- [ ] Type-to-search works smoothly
- [ ] Data saves and shows in admin/reports

### Feature 3 Success:
- [ ] Old records automatically purged
- [ ] Dashboard shows accurate counts
- [ ] Manual purge button works
- [ ] Task Scheduler runs (if configured)

**All three features should work independently** - if one has issues, others continue working normally.

---

## üéâ Deployment Complete!

Once all tests pass:
1. **Inform staff** of new "Who are you visiting?" field
2. **Monitor first week** for any issues
3. **Review auto-purge** after first run
4. **Document any** site-specific notes

**System is now production-ready!**

---

*Last Updated: December 2, 2025*
*Prepared for: Suterra Visitor Management System*
